pipeline {
    agent any

   environment {
        VENV = "${WORKSPACE}/venv"
        SONAR_TOKEN = credentials('SONAR-TOKEN')
        SONAR_HOST_URL = 'http://host.docker.internal:9000'
        DOCKER_IMAGE = 'mohamedbelhaj/djangoproject'
        DOCKER_TAG = "${BUILD_NUMBER}"
        DOCKER_HOST = 'tcp://host.docker.internal:2375'
        DOCKERHUB_CREDENTIALS = credentials('dockerhub-credentials')
    }
    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Install Dependencies') {
            steps {
                echo "Installing Node dependencies..."
                sh 'npm install'
            }
        }

        stage('Unit Tests') {
            steps {
                echo "Running Angular Unit Tests..."
                sh 'npm test -- --watch=false'
            }
        }

        stage('SonarQube Analysis') {
            steps {
                script {
                    withSonarQubeEnv("${SONARQUBE_ENV}") {
                        sh """
                           npx sonar-scanner \
                           -Dsonar.projectKey=threat-analysis-app \
                           -Dsonar.sources=src \
                           -Dsonar.host.url=\${SONAR_HOST_URL} \
                           -Dsonar.login=\${SONAR_AUTH_TOKEN}
                        """
                    }
                }
            }
        }

        stage("Quality Gate") {
            steps {
                timeout(time: 3, unit: 'MINUTES') {
                    script {
                        def qg = waitForQualityGate()
                        if (qg.status != 'OK') {
                            error "√âchec du Quality Gate : ${qg.status}"
                        }
                    }
                }
            }
        }

        stage('Build Angular App') {
            steps {
                echo "Building Angular in production mode..."
                sh 'npm run build --prod'
            }
        }

        stage('Build Docker Image') {
            steps {
                echo "Building Docker image..."
                sh """
                    docker build -t $DOCKER_IMAGE:$DOCKER_TAG .
                """
            }
        }

        stage('Push Docker Image') {
            steps {
                script {
                    echo "Pushing Docker image to registry..."
                    withCredentials([usernamePassword(credentialsId: 'docker-registry-creds', usernameVariable: 'USER', passwordVariable: 'PASS')]) {
                        sh """
                            echo $PASS | docker login $REGISTRY -u $USER --password-stdin
                            docker tag $DOCKER_IMAGE:$DOCKER_TAG $REGISTRY/$DOCKER_IMAGE:$DOCKER_TAG
                            docker push $REGISTRY/$DOCKER_IMAGE:$DOCKER_TAG
                        """
                    }
                }
            }
        }
    }

    post {
        success {
            echo "Pipeline termin√© avec succ√®s üéâ"
        }
        failure {
            echo "La pipeline a √©chou√© ‚ùå"
        }
    }
}
