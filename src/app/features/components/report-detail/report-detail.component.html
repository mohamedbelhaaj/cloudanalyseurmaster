<div class="main-container">
  <!-- Loading State -->
  <div *ngIf="loading" class="loading-overlay">
    <div class="spinner-large"></div>
    <p>Chargement du rapport...</p>
  </div>

  <!-- Error Message -->
  <div *ngIf="errorMessage && !loading" class="card">
    <div class="card-content">
      <div class="alert alert-danger">
        <span class="icon">‚ö†Ô∏è</span>
        <span>{{ errorMessage }}</span>
      </div>
      <button class="btn btn-secondary" (click)="goBack()">Retour</button>
    </div>
  </div>

  <!-- Success Message -->
  <div *ngIf="successMessage" class="card">
    <div class="card-content">
      <div class="alert alert-success">
        <span class="icon">‚úì</span>
        <span>{{ successMessage }}</span>
      </div>
    </div>
  </div>

  <!-- Report Content -->
  <div *ngIf="report && !loading">
    
    <!-- Informations principales -->
    <div class="card">
      <div class="card-content">
        <h3>üîç RAPPORT D'ANALYSE</h3>
        
        <div class="result-section">
          <h4>üìã Informations sur l'entr√©e</h4>
          <div class="info-box">
            <p><strong>Type :</strong> {{ report.input_type }}</p>
            <p><strong>Valeur analys√©e :</strong> {{ report.input_value }}</p>
            <p>
              <strong>S√©v√©rit√© :</strong> 
              <span class="badge" [ngClass]="getSeverityClass(report.severity)">
                {{ report.severity }}
              </span>
            </p>
            <p><strong>Score :</strong> {{ report.threat_score | number:'1.1-1' }}/100</p>
            <p><strong>Moteur utilis√© :</strong> {{ report.engine_used | uppercase }}</p>
            <p><strong>Analyste :</strong> {{ report.analyst.username }}</p>
            <p>
              <strong>Statut :</strong> 
              <span class="badge" [ngClass]="getStatusClass(report.status)">
                {{ report.status }}
              </span>
            </p>
            <hr>
            <p><strong>Date de cr√©ation :</strong> {{ formatDate(report.created_at) }}</p>
            <p *ngIf="report.reviewed_at">
              <strong>Date de r√©vision :</strong> {{ formatDate(report.reviewed_at) }}
            </p>
            <hr>
            <p><strong>Notes :</strong></p>
            <div class="notes-content" [innerHTML]="report.notes || 'Aucune note'"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Statistiques VirusTotal -->
    <div class="card" *ngIf="vtData">
      <div class="card-content">
        <h3>üõ°Ô∏è R√©sultats VirusTotal</h3>
        
        <div class="stats-grid">
          <div class="stat-card malicious">
            <div class="stat-icon">üî¥</div>
            <div class="stat-number">{{ vtData.positives || 0 }}</div>
            <div class="stat-label">D√©tections malveillantes</div>
          </div>
          
          <div class="stat-card clean">
            <div class="stat-icon">‚úÖ</div>
            <div class="stat-number">{{ (vtData.total || 0) - (vtData.positives || 0) }}</div>
            <div class="stat-label">Moteurs propres</div>
          </div>
          
          <div class="stat-card neutral">
            <div class="stat-icon">üìä</div>
            <div class="stat-number">{{ vtData.total || 0 }}</div>
            <div class="stat-label">Total scann√©</div>
          </div>
        </div>

        <!-- Table des d√©tections -->
        <div *ngIf="getVTScans().length > 0">
          <h4>D√©tails des scans</h4>
          <table class="detection-table">
            <thead>
              <tr>
                <th>Moteur antivirus</th>
                <th>R√©sultat</th>
                <th>Statut</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let scan of getVTScans()">
                <td>{{ scan.engine }}</td>
                <td>{{ scan.result }}</td>
                <td>
                  <span class="badge" [ngClass]="scan.detected ? 'badge-danger' : 'badge-success'">
                    {{ scan.detected ? 'D√©tect√©' : 'Propre' }}
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <p *ngIf="vtData.permalink" class="vt-link">
          <a [href]="vtData.permalink" target="_blank" rel="noopener noreferrer" class="btn btn-secondary">
            Voir sur VirusTotal ‚Üí
          </a>
        </p>
      </div>
    </div>

    <!-- Donn√©es OTX -->
    <div class="card" *ngIf="otxData">
      <div class="card-content">
        <h3>üåê R√©sultats AlienVault OTX</h3>
        
        <div class="info-box">
          <p><strong>Nombre de Pulses :</strong> {{ otxData.pulse_count || 0 }}</p>
        </div>

        <div *ngIf="getOTXPulses().length > 0">
          <h4>Pulses associ√©s</h4>
          <div class="pulse-list">
            <div class="pulse-item" *ngFor="let pulse of getOTXPulses()">
              <h5>{{ pulse.name }}</h5>
              <p>{{ pulse.description }}</p>
              <div class="pulse-tags">
                <span class="tag" *ngFor="let tag of pulse.tags">{{ tag }}</span>
              </div>
              <p class="pulse-date">
                <small>Cr√©√© le: {{ formatDate(pulse.created) }}</small>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Donn√©es IPInfo -->
    <div class="card" *ngIf="ipinfoData">
      <div class="card-content">
        <h3>üåç Informations g√©ographiques (IPInfo)</h3>
        
        <div class="info-box">
          <p *ngIf="ipinfoData.ip"><strong>Adresse IP :</strong> {{ ipinfoData.ip }}</p>
          <p *ngIf="ipinfoData.city"><strong>Ville :</strong> {{ ipinfoData.city }}</p>
          <p *ngIf="ipinfoData.region"><strong>R√©gion :</strong> {{ ipinfoData.region }}</p>
          <p *ngIf="ipinfoData.country"><strong>Pays :</strong> {{ ipinfoData.country }}</p>
          <p *ngIf="ipinfoData.org"><strong>Organisation :</strong> {{ ipinfoData.org }}</p>
          <p *ngIf="ipinfoData.loc"><strong>Localisation :</strong> {{ ipinfoData.loc }}</p>
          <p *ngIf="ipinfoData.timezone"><strong>Fuseau horaire :</strong> {{ ipinfoData.timezone }}</p>
        </div>
      </div>
    </div>

    <!-- T√¢ches associ√©es -->
    <div class="card">
      <div class="card-content">
        <h3>üìù T√¢ches associ√©es</h3>
        
        <table class="detection-table" *ngIf="report.tasks && report.tasks.length > 0">
          <thead>
            <tr>
              <th>Titre</th>
              <th>Priorit√©</th>
              <th>Statut</th>
              <th>Assign√© √†</th>
              <th>√âch√©ance</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let task of report.tasks">
              <td>{{ task.title }}</td>
              <td>{{ task.priority }}</td>
              <td>{{ task.status }}</td>
              <td>{{ task.assigned_to.username }}</td>
              <td>{{ formatDate(task.due_date) }}</td>
            </tr>
          </tbody>
        </table>
        
        <p *ngIf="!report.tasks || report.tasks.length === 0" class="no-data">
          Aucune t√¢che associ√©e √† ce rapport.
        </p>
      </div>
    </div>

    <!-- Actions -->
    <div class="card">
      <div class="card-content">
        <h3>‚öôÔ∏è Actions</h3>
        
        <div class="button-group">
          <!-- Actions Admin -->
          <ng-container *ngIf="isAdmin">
            <button class="btn btn-success" (click)="onReviewReport('approve')">
              ‚úì Approuver
            </button>
            <button class="btn btn-warning" (click)="onReviewReport('false_positive')">
              ‚ö† Faux Positif
            </button>
            <button class="btn" (click)="navigateToCreateMitigation()">
              üõ°Ô∏è Cr√©er une Mitigation (AWS)
            </button>
            <button class="btn btn-secondary" (click)="goBack()">
              ‚Üê Retour au Dashboard
            </button>
          </ng-container>

          <!-- Actions Analyste -->
          <ng-container *ngIf="isAnalyst">
            <button class="btn" (click)="downloadPdf()">
              üì• T√©l√©charger le PDF
            </button>
            <button class="btn btn-secondary" (click)="navigateToSendToAdmin()">
              üì§ Envoyer √† l'administrateur
            </button>
            <button class="btn btn-secondary" (click)="navigateToCreateTask()">
              ‚ûï Cr√©er une t√¢che
            </button>
            <button class="btn btn-secondary" (click)="goBack()">
              ‚Üê Retour
            </button>
          </ng-container>
        </div>

        <!-- Formulaire de mise √† jour du statut (Admin uniquement) -->
        <div *ngIf="isAdmin" class="status-update-section">
          <hr>
          <h4>Mettre √† jour le statut et les notes</h4>
          
          <form [formGroup]="statusForm" (ngSubmit)="onUpdateStatus()">
            <div class="form-group">
              <label for="status" class="form-label">Nouveau statut</label>
              <select id="status" class="form-control" formControlName="status">
                <option value="pending">En attente</option>
                <option value="reviewed">Examin√©</option>
                <option value="mitigated">Att√©nu√©</option>
                <option value="false_positive">Faux positif</option>
              </select>
            </div>

            <div class="form-group">
              <label for="notes" class="form-label">Notes (Admin)</label>
              <textarea 
                id="notes" 
                class="form-control" 
                formControlName="notes"
                rows="5"
                placeholder="Ajoutez vos notes..."
              ></textarea>
            </div>

            <button 
              type="submit" 
              class="btn btn-secondary"
              [disabled]="statusForm.invalid || isUpdatingStatus"
            >
              <span *ngIf="!isUpdatingStatus">üíæ Mettre √† jour</span>
              <span *ngIf="isUpdatingStatus">
                <span class="spinner"></span> Mise √† jour...
              </span>
              
            </button>
          </form>
        </div>
      </div>
    </div>

  </div>
</div>
