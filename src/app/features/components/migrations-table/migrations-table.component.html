<div class="mitigation-container">
  
  <header class="page-header">
    <div class="header-content">
      <div class="header-text">
        <h1 class="page-title">Mitigation Actions</h1>
        <p class="page-subtitle">Manage and execute AWS security mitigation actions</p>
      </div>
      <button class="btn btn-primary" (click)="openCreateForm()" [disabled]="loading">
        <i class="fas fa-plus"></i>
        <span>Create Action</span>
      </button>
    </div>
  </header>

  <div class="alerts-section" *ngIf="errorMessage || successMessage">
    <div class="alert alert-danger" *ngIf="errorMessage">
      <i class="fas fa-exclamation-circle"></i>
      <span>{{ errorMessage }}</span>
      <button type="button" class="btn-close" (click)="clearMessages()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="alert alert-success" *ngIf="successMessage">
      <i class="fas fa-check-circle"></i>
      <span>{{ successMessage }}</span>
      <button type="button" class="btn-close" (click)="clearMessages()">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>

  <section class="stats-section" *ngIf="!showForm">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-content">
          <div class="stat-info">
            <span class="stat-label">Total Actions</span>
            <span class="stat-value">{{ stats.total }}</span>
          </div>
          <div class="stat-icon stat-icon-primary">
            <i class="fas fa-tasks"></i>
          </div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-content">
          <div class="stat-info">
            <span class="stat-label">Pending</span>
            <span class="stat-value">{{ stats.pending }}</span>
          </div>
          <div class="stat-icon stat-icon-warning">
            <i class="fas fa-clock"></i>
          </div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-content">
          <div class="stat-info">
            <span class="stat-label">Completed</span>
            <span class="stat-value">{{ stats.completed }}</span>
          </div>
          <div class="stat-icon stat-icon-success">
            <i class="fas fa-check-circle"></i>
          </div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-content">
          <div class="stat-info">
            <span class="stat-label">Success Rate</span>
            <span class="stat-value">{{ getSuccessRate() }}%</span>
          </div>
          <div class="stat-icon stat-icon-info">
            <i class="fas fa-chart-line"></i>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="filters-section" *ngIf="!showForm">
    <div class="filters-card">
      <div class="filters-grid">
        <div class="filter-group">
          <label class="filter-label">Status</label>
          <select class="filter-select" [(ngModel)]="selectedStatus" (change)="onFilterChange()">
            <option *ngFor="let option of getStatusOptions()" [value]="option.value">
              {{ option.label }}
            </option>
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">Action Type</label>
          <select class="filter-select" [(ngModel)]="selectedActionType" (change)="onFilterChange()">
            <option *ngFor="let option of getActionTypeFilterOptions()" [value]="option.value">
              {{ option.label }}
            </option>
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">Search</label>
          <input type="text" 
                 class="filter-input" 
                 placeholder="Search target or description..."
                 [(ngModel)]="searchTerm" 
                 (input)="onFilterChange()">
        </div>
      </div>
    </div>
  </section>

  <div class="loading-section" *ngIf="loading && !showForm">
    <div class="loading-spinner">
      <div class="spinner"></div>
      <span class="loading-text">Loading mitigations...</span>
    </div>
  </div>

  <section class="mitigations-section" *ngIf="!showForm && !loading">
    
    <div class="empty-state" *ngIf="filteredMitigations.length === 0">
      <i class="fas fa-inbox"></i>
      <h3>No mitigation actions found</h3>
      <p>Create your first action to get started</p>
    </div>

    <div class="mitigation-list">
      <article class="mitigation-card" *ngFor="let mitigation of filteredMitigations">
        
        <div class="mitigation-content">
          
          <div class="mitigation-main">
            <div class="mitigation-icon">
              <i class="fas" [ngClass]="mitigationService.getActionTypeIcon(mitigation.action_type)"></i>
            </div>
            <div class="mitigation-details">
              <h3 class="mitigation-title">{{ mitigationService.getActionTypeLabel(mitigation.action_type) }}</h3>
              <div class="mitigation-meta">
                <span class="meta-item">
                  <i class="fas fa-crosshairs"></i>
                  <strong>Target:</strong>
                  <code>{{ mitigation.target_value }}</code>
                </span>
                <span class="meta-item">
                  <i class="fas fa-globe"></i>
                  <strong>Region:</strong>
                  <span>{{ mitigationService.getRegionLabel(mitigation.aws_region) }}</span>
                </span>
              </div>
            </div>
          </div>

          <div class="mitigation-description">
            <div class="description-label">
              <i class="fas fa-info-circle"></i> Description
            </div>
            <p class="description-text">{{ mitigation.description }}</p>
          </div>

          <div class="mitigation-status">
            <span class="status-badge" [ngClass]="mitigationService.getStatusBadgeClass(mitigation.status)">
              <i class="fas" [ngClass]="mitigationService.getStatusIcon(mitigation.status)"></i>
              {{ mitigation.status }}
            </span>
            
            <div class="meta-item">
              <i class="fas fa-user"></i> {{ mitigation.initiated_by_username }}
            </div>
            <div class="meta-item">
              <i class="fas fa-clock"></i> {{ formatDate(mitigation.created_at) }}
            </div>
          </div>

          <div class="mitigation-status" style="align-items: flex-end;"> <button class="btn btn-primary" 
                    style="width: 100%; justify-content: center;"
                    *ngIf="canExecute(mitigation)"
                    (click)="executeMitigation(mitigation)"
                    [disabled]="isExecuting(mitigation.id!)">
              <span *ngIf="isExecuting(mitigation.id!)" class="btn-spinner"></span>
              <i *ngIf="!isExecuting(mitigation.id!)" class="fas fa-play"></i>
              <span>Execute</span>
            </button>
            
            <div style="display: flex; gap: 0.5rem; width: 100%;">
                <button class="btn btn-secondary" 
                        style="flex: 1; justify-content: center;"
                        (click)="openEditForm(mitigation)"
                        [disabled]="mitigation.status === 'in_progress'">
                <i class="fas fa-edit"></i>
                </button>
                
                <button class="btn btn-secondary" 
                        style="flex: 1; justify-content: center; border-color: rgba(239, 68, 68, 0.4); color: #fca5a5;"
                        (click)="deleteMitigation(mitigation)"
                        [disabled]="mitigation.status === 'in_progress'">
                <i class="fas fa-trash"></i>
                </button>
            </div>
          </div>

        </div> <div class="alert alert-danger" style="margin-top: 1rem;" *ngIf="mitigation.status === 'failed' && mitigation.error_message">
          <i class="fas fa-exclamation-triangle"></i>
          <span><strong>Error:</strong> {{ mitigation.error_message }}</span>
        </div>

        <div class="alert alert-success" style="margin-top: 1rem;" *ngIf="mitigation.status === 'completed' && mitigation.error_message">
          <i class="fas fa-check-circle"></i>
          <span>{{ mitigation.error_message }}</span>
        </div>

      </article>
    </div>
  </section>

  <section class="filters-section" *ngIf="showForm"> <div class="filters-card" style="max-width: 800px; margin: 0 auto;">
      
      <div class="page-header" style="margin-bottom: 1.5rem;">
        <h2 class="page-title" style="font-size: 1.8rem;">
            {{ isEditing ? 'Edit' : 'Create' }} Mitigation Action
        </h2>
      </div>
      
      <form [formGroup]="mitigationForm" (ngSubmit)="onSubmit()">
        
        <div class="filters-grid" style="margin-bottom: 1.5rem;">
          <div class="filter-group">
            <label class="filter-label">Action Type *</label>
            <select class="filter-select" formControlName="action_type">
              <option *ngFor="let type of getActionTypeOptions()" [value]="type.value">
                {{ type.label }}
              </option>
            </select>
          </div>

          <div class="filter-group">
            <label class="filter-label">AWS Region *</label>
            <select class="filter-select" formControlName="aws_region">
              <option *ngFor="let region of getRegionOptions()" [value]="region.value">
                {{ region.label }}
              </option>
            </select>
          </div>
        </div>

        <div class="filters-grid" style="margin-bottom: 1.5rem;">
          <div class="filter-group" [style.grid-column]="shouldShowRuleNumber() ? 'span 1' : 'span 2'">
            <label class="filter-label">Target Value *</label>
            <input type="text" class="filter-input" 
                   formControlName="target_value"
                   [placeholder]="getTargetPlaceholder()">
            <small style="color: #94a3b8; font-size: 0.8rem; margin-top: 4px;">
                IP address, instance ID, etc.
            </small>
          </div>

          <div class="filter-group" *ngIf="shouldShowRuleNumber()">
            <label class="filter-label">NACL Rule Number *</label>
            <input type="number" class="filter-input" formControlName="rule_number">
          </div>
        </div>

        <div class="filter-group" style="margin-bottom: 2rem;">
          <label class="filter-label">Description *</label>
          <textarea class="filter-input" 
                    formControlName="description" 
                    rows="4"
                    style="resize: vertical; min-height: 100px;"
                    placeholder="Describe the reason for this action..."></textarea>
        </div>

        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
          <button type="button" class="btn btn-secondary" (click)="closeForm()" [disabled]="loading">
            Cancel
          </button>
          
          <button type="submit" class="btn btn-primary" [disabled]="loading || mitigationForm.invalid">
            <span *ngIf="loading" class="btn-spinner"></span>
            <span>{{ isEditing ? 'Update' : 'Create' }} Action</span>
          </button>
        </div>

      </form>
    </div>
  </section>

</div>